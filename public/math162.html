<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math162</title>

    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Math162 Data</h1>
    
    <div id="summary">
        <p><strong>Percentage:</strong> <span id="percentage">Calculating...</span>%</p>
        <p><strong>Grade:</strong> <span id="grade">Calculating...</span></p>
    </div>

    <div id="data-container">Loading...</div>
    <button id="update-button" style="display: none;">Update</button>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (!firebase.apps.length) {
                firebase.initializeApp({
                    apiKey: "AIzaSyDgGep8pRJL0FAWPdfN9itD6EGN6nk2n3E",
                    authDomain: "general-ansar-nu.firebaseapp.com",
                    projectId: "general-ansar-nu",
                    storageBucket: "general-ansar-nu.appspot.com",
                    messagingSenderId: "1098834811917",
                    appId: "1:1098834811917:web:df4b3be734f5f9e1644944",
                    measurementId: "G-Y965GPDQJX"
                });
            }

            const auth = firebase.auth();
            const db = firebase.firestore();
            let userEmail = null;

            function calculatePercentage(data) {
                let totalEarned = (data["q1"] || 0)*0.3 + (data["q2"] || 0)*0.3 + (data["q3"] || 0)*0.3 + (data["h"] || 0)*0.1;
                //let totalPossible = 30 + 30 + 30 + 10; // Max possible points
                return ((totalEarned) * 1).toFixed(2);
            }

            function calculateGrade(percentage) {
                if (percentage >= 90) return "A";
                if (percentage >= 80) return "B";
                if (percentage >= 70) return "C";
                if (percentage >= 60) return "D";
                return "F";
            }

            auth.onAuthStateChanged((user) => {
                if (user && user.email.endsWith("@nu.edu.kz")) {
                    userEmail = user.email;
                    console.log("Authenticated as:", userEmail);

                    const docRef = db.collection("math162").doc(userEmail);
                    docRef.get().then((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log("Fetched Data:", data);

                            let html = '<form id="data-form">';
                            for (let key in data) {
                                if (data.hasOwnProperty(key)) {
                                    html += `<p>${key}: <input type="number" id="${key}" value="${data[key]}" min="0" max="30"></p>`;
                                }
                            }
                            html += '</form>';
                            document.getElementById("data-container").innerHTML = html;
                            document.getElementById("update-button").style.display = "block";

                            // Calculate and display the percentage and grade
                            let percentage = calculatePercentage(data);
                            document.getElementById("percentage").innerText = percentage;
                            document.getElementById("grade").innerText = calculateGrade(percentage);
                        } else {
                            document.getElementById("data-container").innerHTML = `<p>No data found for ${userEmail}.</p>`;
                        }
                    }).catch((error) => {
                        console.error("Error fetching document:", error);
                        document.getElementById("data-container").innerHTML = `<p>Error loading data.</p>`;
                    });
                } else {
                    window.location.href = "index.html";
                }
            });

            document.getElementById("update-button").addEventListener("click", function () {
                if (!userEmail) return;

                const inputs = document.querySelectorAll("#data-form input");
                let updateData = {};
                let valid = true;

                inputs.forEach(input => {
                    let value = parseInt(input.value, 10);
                    if (isNaN(value) || value < 0 || value > 100) {
                        valid = false;
                    } else {
                        updateData[input.id] = value;
                    }
                });

                if (!valid) {
                    alert("Invalid input! Values must be between 0 and 30.");
                    return;
                }

                db.collection("math162").doc(userEmail).update(updateData)
                    .then(() => {
                        alert("Data updated successfully!");
                        let percentage = calculatePercentage(updateData);
                        document.getElementById("percentage").innerText = percentage;
                        document.getElementById("grade").innerText = calculateGrade(percentage);
                    })
                    .catch((error) => {
                        console.error("Error updating document:", error);
                        alert("Failed to update data.");
                    });
            });
        });
    </script>
</body>
</html>